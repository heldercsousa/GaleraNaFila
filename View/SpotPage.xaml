<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:local="clr-namespace:MyKaraoke.View"
             xmlns:components="clr-namespace:MyKaraoke.View.Components"
             xmlns:domain="clr-namespace:MyKaraoke.Domain;assembly=MyKaraoke.Domain"
             xmlns:behaviors="clr-namespace:MyKaraoke.View.Behaviors"
             x:Class="MyKaraoke.View.SpotPage"
             x:DataType="local:SpotPage"
             Background="{StaticResource AppBackgroundGradient}"
             NavigationPage.HasNavigationBar="False">

    <!-- ✅ BEHAVIORS: SmartPageLifecycleBehavior + SafeNavigationBehavior -->
    <ContentPage.Behaviors>
        <behaviors:SmartPageLifecycleBehavior 
            NavBar="{x:Reference CrudNavBar}"
            MainContent="{x:Reference mainContentGrid}"
            LoadDataCommand="{Binding LoadDataCommand}"
            EnableAutoBypass="True"
            MaxFailuresBeforeBypass="2" />

        <!-- ✅ NAVEGAÇÃO PARA FORMULÁRIO: SpotFormPage -->
        <behaviors:SafeNavigationBehavior 
            x:Name="SpotFormNavigationBehavior"
            EnableSmartStackNavigation="True"   
            DebounceMilliseconds="800" />

        <!-- ✅ NAVEGAÇÃO INTELIGENTE DE VOLTA: Usa stack navigation -->
        <behaviors:SafeNavigationBehavior 
            x:Name="BackNavigationBehavior"
            EnableSmartStackNavigation="True"
            DebounceMilliseconds="500" />
    </ContentPage.Behaviors>

    <Grid RowDefinitions="Auto,*,Auto">
        <components:HeaderComponent Grid.Row="0" Title="Locais" />

        <Grid Grid.Row="1" x:Name="mainContentGrid">

            <components:CardWrapperComponent TitleText="Cadastrados" IconPath="spot_purple.png" BadgeIsVisible="False">
                <components:CardWrapperComponent.CardContent>
                    <Grid RowDefinitions="*">
                        <CollectionView x:Name="locaisCollectionView"
                                      ItemsSource="{Binding Locais}"
                                      SelectionMode="Multiple"
                                      SelectionChanged="OnLocalSelectionChanged">
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="domain:Estabelecimento">
                                    <Frame Style="{StaticResource CardListItemBackgroundStyle}" Padding="15,12" Margin="0,5">
                                        <VisualStateManager.VisualStateGroups>
                                            <VisualStateGroup Name="CommonStates">
                                                <VisualState Name="Normal" />
                                                <VisualState Name="Selected">
                                                    <VisualState.Setters>
                                                        <Setter Property="BackgroundColor" Value="#1A4A1D" />
                                                        <Setter Property="BorderColor" Value="#2E7D32" />
                                                    </VisualState.Setters>
                                                </VisualState>
                                            </VisualStateGroup>
                                        </VisualStateManager.VisualStateGroups>
                                        <Label Text="{Binding Nome}" FontSize="16" FontAttributes="Bold" TextColor="White" VerticalOptions="Center"/>
                                    </Frame>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>

                        <Frame x:Name="emptyStateFrame" IsVisible="False" Grid.Row="0" Style="{StaticResource EmptyQueueFrameStyle}">
                            <StackLayout Spacing="15" VerticalOptions="Start">
                                <Label Text="Nenhum local cadastrado" Style="{StaticResource EmptyQueueTitleStyle}" />
                                <Label Style="{StaticResource EmptyQueueTextStyle}">
                                    <Label.FormattedText>
                                        <FormattedString>
                                            <Span Text="• Toque no botão " />
                                            <Span Text="Adicionar" TextColor="White" FontAttributes="Bold" />
                                            <Span Text=" abaixo para cadastrar seu primeiro local" />
                                        </FormattedString>
                                    </Label.FormattedText>
                                </Label>
                            </StackLayout>
                        </Frame>
                    </Grid>
                </components:CardWrapperComponent.CardContent>
            </components:CardWrapperComponent>

        </Grid>

        <components:CrudNavBarComponent Grid.Row="2"
                                      x:Name="CrudNavBar"
                                      SelectionCount="{Binding SelectionCount}"
                                      ButtonClicked="OnCrudNavBarButtonClicked"/>
    </Grid>
</ContentPage>